name: 'Build Valve Source Plugin Navmesh'
description: 'Builds the valve_source_plugin_navmesh for various platforms'
inputs:
  repo-path:
    description: 'Path to the valve_source_plugin_navmesh repository within the workspace'
    required: true
    default: 'valve_source_plugin_navmesh' # Default to the cloned directory name

runs:
  using: "composite"
  steps:
    - name: Checkout valve_source_plugin_navmesh
      uses: actions/checkout@v4
      with:
        path: ${{ inputs.repo-path }}
        repository: Xeogin/valve_source_plugin_navmesh
        token: ${{ github.token }}
        ssh-strict: true
        ssh-user: git
        persist-credentials: true
        clean: true
        sparse-checkout-cone-mode: true
        fetch-depth: 1
        fetch-tags: false
        show-progress: true
        lfs: false
        submodules: false
        set-safe-directory: true

    - name: Checkout Source SDK 2013
      uses: actions/checkout@v4
      with:
        repository: ValveSoftware/source-sdk-2013
        ref: master
        path: source-sdk-2013
        token: ${{ github.token }}
        ssh-strict: true
        ssh-user: git
        persist-credentials: true
        clean: true
        sparse-checkout-cone-mode: true
        fetch-depth: 1
        fetch-tags: false
        show-progress: true
        lfs: false
        submodules: false
        set-safe-directory: true

    # --- Linux Specific Steps ---
    - name: Prepare Source SDK for Linux (64-bit)
      if: runner.os == 'Linux'
      run: |
        # Update packages and install necessary build tools
        sudo apt-get update
        sudo apt-get install -y build-essential gcc-multilib g++-multilib lib32gcc-s1 lib32stdc++6

        # Navigate to the SDK source directory and run buildallprojects
        # This script compiles the SDK's internal libraries (tier0, tier1, vstdlib, mathlib, lzma)
        # for Linux, creating .a files that your plugin will link against.
        cd "${{github.workspace}}/source-sdk-2013/src"
        ./buildallprojects
      shell: bash

    - name: Configure CMake for Linux
      if: runner.os == 'Linux'
      run: |
        cd "${{ github.workspace }}/${{ inputs.repo-path }}"
        mkdir -p build_linux
        cd build_linux

        cmake \
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/source-sdk-2013/linux_tools/linux_gcc_64.cmake" \
          -DCMAKE_BUILD_TYPE=Release \
          -DSOURCE_SDK_PATH="${{ github.workspace }}/source-sdk-2013" \
          ..
      shell: bash

    - name: Build with CMake for Linux
      if: runner.os == 'Linux'
      run: |
        cd "${{ github.workspace }}/${{ inputs.repo-path }}/build_linux"
        cmake --build . -j $(nproc)
      shell: bash

    - name: Upload Linux Artifact
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: navmesh-plugin-linux
        path: ${{ github.workspace }}/${{ inputs.repo-path }}/build_linux/*.so

    # --- Windows Specific Steps ---
    # NEW STEP: Build Source SDK 2013 Libraries on Windows
    - name: Build Source SDK 2013 Libraries (Windows)
      if: runner.os == 'Windows'
      run: |
        # Use MSBuild to compile the Source SDK solution.
        # The VSSDK2013.sln is typically found in the 'src' directory of the source-sdk-2013 checkout.
        # This step generates the .lib files (tier0.lib, tier1.lib, vstdlib.lib, etc.)
        # that your plugin will link against.
        # /p:Configuration=Release : Builds the Release configuration of the SDK libraries.
        # /p:Platform=Win32      : Compiles for 32-bit (most common for Source SDK mods).
        #                          If your plugin targets 64-bit, change to /p:Platform=x64.
        # /m                     : Enables multi-processor compilation for faster builds.
        msbuild.exe "${{ github.workspace }}/source-sdk-2013/src/VSSDK2013.sln" /p:Configuration=Release /p:Platform=Win32 /m
      shell: cmd # MSBuild commands are best run directly with the cmd shell on Windows

    - name: Configure CMake for Windows
      if: runner.os == 'Windows'
      run: |
        # Ensure you are in your plugin's directory for CMake configuration
        cd "${{ github.workspace }}/${{ inputs.repo-path }}"
        
        # Create a build directory if it doesn't exist
        mkdir -p build_windows
        cd build_windows

        # Configure CMake for a Release build targeting Windows.
        # CMake will automatically find Visual Studio if it's in the PATH.
        cmake -G "Visual Studio 17 2022" \
          -DCMAKE_BUILD_TYPE=Release \
          -DSOURCE_SDK_PATH="${{ github.workspace }}/source-sdk-2013" \
          .. # Point to the parent directory where your CMakeLists.txt resides
      shell: bash # Using bash is generally more robust for path handling in GHA on Windows

    - name: Build with CMake for Windows
      if: runner.os == 'Windows'
      run: |
        # Navigate to the build directory created in the previous step
        cd "${{ github.workspace }}/${{ inputs.repo-path }}/build_windows"

        # Build the project using CMake. CMake will invoke MSBuild.
        cmake --build . --config Release
      shell: bash

    - name: Upload Windows Artifact
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: navmesh-plugin-windows
        path: |
          ${{ github.workspace }}/${{ inputs.repo-path }}/build_windows/Release/*.dll
          ${{ github.workspace }}/${{ inputs.repo-path }}/build_windows/Debug/*.dll
