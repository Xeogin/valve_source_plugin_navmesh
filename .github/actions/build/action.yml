name: 'Build'
description: 'Builds the Nav Mesh Project'
inputs:
  repo-path:
    description: 'Path to the plugin project source'
    required: true
runs:
  using: "composite"
  steps:
    - name: Checkout HL2SDK from Allied Modders
      uses: actions/checkout@v4
      with:
        repository: alliedmodders/hl2sdk
        ref: hl2dm
        path: hl2sdk # HL2SDK will be checked out here, relative to the composite action's CWD

    # UPDATED DEBUG STEP FOR 64-BIT (NON-FAILING)
    # Corrected path by removing ${{github.workspace}} inside the `run` block
    - name: Debug - List HL2SDK Linux64 Libraries
      if: runner.os == 'Linux'
      run: |
        echo "Listing contents of hl2sdk/lib/public/linux64:"
        ls -l hl2sdk/lib/public/linux64/ || true # Path is now relative to action's CWD
        echo ""
        echo "Listing contents of hl2sdk/lib/common/linux64:"
        ls -l hl2sdk/lib/common/linux64/ || true # Path is now relative to action's CWD
      shell: bash

    - name: Configure CMake
      run: |
        # Use full paths for CMake commands as they are relative to the main workflow's workspace
        cmake_command="cmake -S \"${{github.workspace}}/${{ inputs.repo-path }}\" -B \"${{github.workspace}}/build\" -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}"
        eval "$cmake_command"
      env:
        BUILD_TYPE: Release
      shell: bash

    - name: Build Project
      run: cmake --build "${{github.workspace}}/build" --config ${{env.BUILD_TYPE}}
      env:
        BUILD_TYPE: Release
      shell: bash

    - name: Upload Linux Plugin Artifact
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: navmesh-plugin-linux
        path: ${{github.workspace}}/build/test/libplugin_navmesh.so

    - name: Upload Windows Plugin Artifact
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: navmesh-plugin-windows
        path: ${{github.workspace}}/build/test/Release/plugin_navmesh.dll
