name: 'Build Valve Source Plugin Navmesh'
description: 'Builds the valve_source_plugin_navmesh for various platforms'
inputs:
  repo-path:
    description: 'Path to the valve_source_plugin_navmesh repository within the workspace'
    required: true
    default: 'valve_source_plugin_navmesh'

runs:
  using: "composite"
  steps:
    - name: Checkout valve_source_plugin_navmesh
      uses: actions/checkout@v4
      with:
        path: ${{ inputs.repo-path }}
        repository: Xeogin/valve_source_plugin_navmesh
        token: ${{ github.token }}
        ssh-strict: true
        ssh-user: git
        persist-credentials: true
        clean: true
        sparse-checkout-cone-mode: true
        fetch-depth: 1
        fetch-tags: false
        show-progress: true
        lfs: false
        submodules: false
        set-safe-directory: true

    - name: Checkout Source SDK 2013
      uses: actions/checkout@v4
      with:
        repository: ValveSoftware/source-sdk-2013
        ref: master
        path: source-sdk-2013
        token: ${{ github.token }}
        persist-credentials: true
        clean: true
        fetch-depth: 1
        fetch-tags: false
        show-progress: true
        lfs: false
        submodules: false
        set-safe-directory: true

    - name: "List Source SDK src contents Windows (Initial Check)"
      if: runner.os == 'Windows'
      run: |
        echo "Attempting to list contents of src directory."
        dir "${{ github.workspace }}\source-sdk-2013\src"
      shell: cmd

    # --- Linux Specific Steps (no change) ---
    - name: Prepare Source SDK for Linux (64-bit)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc-multilib g++-multilib lib32gcc-s1 lib32stdc++6
        cd "${{github.workspace}}/source-sdk-2013/src"
        ./buildallprojects
      shell: bash

    - name: Configure CMake for Linux
      if: runner.os == 'Linux'
      run: |
        cd "${{ github.workspace }}/${{ inputs.repo-path }}"
        mkdir -p build_linux
        cd build_linux

        cmake \
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/source-sdk-2013/linux_tools/linux_gcc_64.cmake" \
          -DCMAKE_BUILD_TYPE=Release \
          -DSOURCE_SDK_PATH="${{ github.workspace }}/source-sdk-2013" \
          ..
      shell: bash

    - name: Build with CMake for Linux
      if: runner.os == 'Linux'
      run: |
        cd "${{ github.workspace }}/${{ inputs.repo-path }}/build_linux"
        cmake --build . -j $(nproc)
      shell: bash

    - name: Upload Linux Artifact
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: navmesh-plugin-linux
        path: ${{ github.workspace }}/${{ inputs.repo-path }}/build_linux/*.so

    # --- Windows Specific Steps (changes here) ---
    - name: Generate and Build Source SDK 2013 (Windows)
      if: runner.os == 'Windows'
      run: |
        REM Set up the Visual Studio build environment (x64)
        CALL "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat" x64
        
        REM Navigate to the SDK source directory
        PUSHD "${{ github.workspace }}\source-sdk-2013\src"
        
        REM Run VPC to generate project and solution files
        createallprojects.bat
        
        REM Build the 'everything.sln' solution with detailed output.
        REM Removed /maxcpucount to ensure all build messages are clearer.
        msbuild everything.sln /p:Configuration="Release" /p:Platform="x64" /v:d
        
        REM Return to the previous directory
        POPD
      shell: cmd

    - name: "Inspect Source SDK x64 lib output (Crucial Step)"
      if: runner.os == 'Windows'
      run: |
        echo "Listing contents of source-sdk-2013/src/lib/public/x64:"
        dir "${{ github.workspace }}\source-sdk-2013\src\lib\public\x64"
        echo "Listing ALL .lib files found recursively in source-sdk-2013/src/lib/public:"
        dir "${{ github.workspace }}\source-sdk-2013\src\lib\public\" /s /b *.lib
      shell: cmd

    - name: Configure CMake for Windows
      if: runner.os == 'Windows'
      run: |
        # Ensure you are in your plugin's directory for CMake configuration
        cd "${{ github.workspace }}/${{ inputs.repo-path }}"

        # Create a build directory if it doesn't exist
        mkdir -p build_windows
        cd build_windows

        # Configure CMake for a Release build targeting Windows.
        # CMake will automatically find Visual Studio if it's in the PATH.
        cmake -G "Visual Studio 17 2022" \
          -DCMAKE_BUILD_TYPE=Release \
          -DSOURCE_SDK_PATH="${{ github.workspace }}/source-sdk-2013" \
          .. # Point to the parent directory where your CMakeLists.txt resides
      shell: bash

    - name: Build with CMake for Windows
      if: runner.os == 'Windows'
      run: |
        # Navigate to the build directory created in the previous step
        cd "${{ github.workspace }}/${{ inputs.repo-path }}/build_windows"

        # Build the project using CMake. CMake will invoke MSBuild.
        cmake --build . --config Release
      shell: bash

    - name: Upload Windows Artifact
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: navmesh-plugin-windows
        path: |
          ${{ github.workspace }}/${{ inputs.repo-path }}/build_windows/Release/*.dll
          ${{ github.workspace }}/${{ inputs.repo-path }}/build_windows/Debug/*.dll
