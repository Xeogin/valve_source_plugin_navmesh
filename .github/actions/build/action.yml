name: 'Build'
description: 'Builds the Nav Mesh Project'
inputs:
  repo-path:
    description: 'Path to the plugin project source'
    required: true
runs:
  using: "composite"
  steps:
    - name: Checkout HL2SDK from Allied Modders
      uses: actions/checkout@v4
      with:
        repository: alliedmodders/hl2sdk
        ref: hl2dm
        path: hl2sdk

    - name: Configure CMake
      run: |
        # Build the base cmake command
        cmake_command="cmake -S \"${{github.workspace}}/${{ inputs.repo-path }}\" -B \"${{github.workspace}}/build\" -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}"
        
        # Add 32-bit flags specifically for Linux compilation
        if [ "${{ runner.os }}" == "Linux" ]; then
          cmake_command+=" -DCMAKE_C_FLAGS=\"-m32\" -DCMAKE_CXX_FLAGS=\"-m32\""
        fi
        
        # Execute the full cmake command
        eval "$cmake_command"
      env:
        BUILD_TYPE: Release
      shell: bash

    # --- ADD THIS MISSING BUILD STEP HERE ---
    - name: Build Project
      run: cmake --build "${{github.workspace}}/build" --config ${{env.BUILD_TYPE}}
      env:
        BUILD_TYPE: Release
      shell: bash
    # --- END MISSING BUILD STEP ---

    # --- FINAL ARTIFACT UPLOAD STEPS (with original names) ---

    - name: Upload Linux Plugin Artifact
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: navmesh-plugin-linux # Reverted to original name
        path: ${{github.workspace}}/build/test/libplugin_navmesh.so

    - name: Upload Windows Plugin Artifact
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: navmesh-plugin-windows # Reverted to original name
        path: ${{github.workspace}}/build/test/Release/plugin_navmesh.dll

    # --- END FINAL ARTIFACT UPLOAD STEPS ---
